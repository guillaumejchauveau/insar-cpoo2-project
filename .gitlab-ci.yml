stages:
  - build
  - review
  - staging

build-back:
  image: registry.gitlab.inria.fr/diverse/docker/docker-image/insa-maven:3.6.2-jdk-11
  stage: build
  tags:
    - build
  script:
    - cd game-backend
    - mvn -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository clean package
  cache:
    paths:
      - $CI_PROJECT_DIR/.m2/repository/
      - game-backend/target/
  artifacts:
    paths:
      - game-backend/target/*.jar
    expire_in: 1 hour

build-front:
  image: registry.gitlab.inria.fr/diverse/docker/docker-image/insa-node:14.17.0
  stage: build
  tags:
    - build
  cache:
    paths:
      - node_modules/
  script:
    - cd game-frontend
    - npm install
    - npm run ng build --prod --build-optimizer

review:
  stage: review
  tags:
    - review
  script:
    - echo "review"
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: http://$CI_BUILD_REF_SLUG.$KUBE_INGRESS_BASE_DOMAIN 
  only:
    - branches
  except:
    - master

staging:
  stage: staging
  tags:
    - staging
  script:
    - echo "staging"
  environment:
    name: staging
    url: http://staging.$KUBE_INGRESS_BASE_DOMAIN
  only:
    - master
